# ğŸš€ ä½¿ç”¨ Stream å¤„ç†å¤§æ–‡ä»¶ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å†…å­˜

---

## âœ… ä¸ºä»€ä¹ˆè¦ç”¨ Streamï¼Ÿ

Node.js æ˜¯åŸºäºäº‹ä»¶å¾ªç¯çš„å•çº¿ç¨‹æ¨¡å‹ï¼Œå¦‚æœä½ è¯»å–ä¸€ä¸ªå¤§æ–‡ä»¶ï¼š

```js
// âŒ ä¸æ¨è
const data = fs.readFileSync('large.txt', 'utf8');
```

è¿™ä¸ªå†™æ³•æœ‰ä¸¤ä¸ªä¸¥é‡é—®é¢˜ï¼š

1. **åŒæ­¥é˜»å¡**ï¼š`readFileSync` ä¼šå¡ä½ä¸»çº¿ç¨‹ï¼›
2. **å†…å­˜çˆ†ç‚¸**ï¼šä¸€æ¬¡æ€§æŠŠå¤§æ–‡ä»¶ï¼ˆå¦‚ 1GB æ—¥å¿—ï¼‰è¯»è¿›å†…å­˜ï¼Œéå¸¸å®¹æ˜“ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰ã€‚

---

## âœ… Stream çš„æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹ç‚¹     | æè¿°                                                     |
| ------ | ------------------------------------------------------ |
| åˆ†æ®µè¯»å–   | æ•°æ®è¢«åˆ†æˆå°å—ï¼ˆchunkï¼‰å¤„ç†ï¼Œé™ä½å†…å­˜                                  |
| å¼‚æ­¥éé˜»å¡  | ä½¿ç”¨äº‹ä»¶ç›‘å¬ï¼Œä¸å¡ä½ä¸»çº¿ç¨‹                                          |
| æµå¼å¤„ç†   | å¯è¾¹è¯»å–è¾¹å†™å…¥ï¼Œè¾¹è½¬ç è¾¹ä¼ è¾“                                         |
| èŠ‚ç‚¹çº§åˆ«æ”¯æŒ | åŸç”Ÿ `fs.createReadStream`, `http`, `zlib`, `crypto` éƒ½æ˜¯æµ |

---

## ğŸ“¦ å››ç§æµç±»å‹ï¼ˆNode.js åŸç”Ÿ Streamï¼‰

1. **Readable**ï¼šå¯è¯»æµï¼ˆè¯»å–æ–‡ä»¶ï¼‰
2. **Writable**ï¼šå¯å†™æµï¼ˆå†™å…¥æ–‡ä»¶ï¼‰
3. **Duplex**ï¼šåŒå‘æµï¼ˆTCPï¼‰
4. **Transform**ï¼šè½¬æ¢æµï¼ˆgzip, è§£å¯†ï¼‰

---

## âœ… ç¤ºä¾‹ï¼šç”¨ Stream è¯»å–å¤§æ–‡ä»¶å¹¶å‘é€å“åº”

```js
const fs = require('fs');
const http = require('http');

http.createServer((req, res) => {
  const readStream = fs.createReadStream('./bigfile.txt');
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  readStream.pipe(res); // âœ… è¾¹è¯»è¾¹ä¼ ï¼Œä¸å å†…å­˜
}).listen(3000);
```

âœ”ï¸ é€‚åˆç”¨äºè§†é¢‘ã€æ—¥å¿—ã€CSV å¯¼å‡ºç­‰å¤§ä½“ç§¯ä¼ è¾“åœºæ™¯ã€‚

---

## âœ… ç¤ºä¾‹ï¼šæµå¼å¤„ç† CSV å¹¶é€è¡Œå…¥åº“ï¼ˆé¿å…çˆ†å†…å­˜ï¼‰

```js
const fs = require('fs');
const readline = require('readline');

async function processCSV() {
  const fileStream = fs.createReadStream('./big.csv');

  const rl = readline.createInterface({
    input: fileStream,
    crlfDelay: Infinity
  });

  for await (const line of rl) {
    const values = line.split(',');
    await db.insert(values); // âœ… æ§åˆ¶é€æ¡å†™å…¥ï¼Œä¸å¡ä¸»çº¿ç¨‹
  }
}
```

---

## âŒ vs â— å¸¸è§è¯¯åŒºï¼šä¸€æ¬¡æ€§è¯»å–å¾ˆå±é™©ï¼

```js
// ä¼šä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå ç”¨ä¸¥é‡
const file = await fs.promises.readFile('./hugefile.csv', 'utf8');
```

å³ä½¿æ˜¯å¼‚æ­¥ï¼Œä½†ç”±äºæ•°æ®å¤ªå¤§ï¼Œ**ä»ç„¶å¯èƒ½å‹å®è¿›ç¨‹å†…å­˜**ã€‚

---

## ğŸ§  å®æˆ˜åœºæ™¯å¯¹æ¯”

| åœºæ™¯          | æ™®é€šæ–¹å¼             | ä½¿ç”¨ Stream çš„ä¼˜åŠ¿                 |
| ----------- | ---------------- | ----------------------------- |
| æ—¥å¿—ä¸‹è½½        | å…ˆè¯»å…¥å†…å­˜å†å‘é€         | å¯è¾¹è¯»è¾¹å‘ï¼Œæ”¯æŒæ— é™å¤§æ—¥å¿—                 |
| è§†é¢‘ä¼ è¾“        | Base64 ç¼–ç è¯»å–      | ä½¿ç”¨ stream.pipe() è¾¹ä¼ è¾¹ç¼“å­˜        |
| ä¸Šä¼ å¤§æ–‡ä»¶       | ä½¿ç”¨ `busboy` ç­‰è§£ææµ | èŠ‚çœä¸´æ—¶ç£ç›˜ & å†…å­˜å ç”¨                 |
| è§£å‹ zip/gzip | è§£å‹åä¸€æ¬¡æ€§è¯»å…¥         | ä½¿ç”¨ `zlib.createGunzip()` æµå¼è§£å‹ |

---

## ğŸ§° å¸¸ç”¨å·¥å…·é“¾æ¨è

| ç±»å‹    | å·¥å…·/åº“                                 | ç”¨é€”        |
| ----- | ------------------------------------ | --------- |
| è§£ææµæ–‡ä»¶ | `readline`, `csv-parser`, `fast-csv` | CSV / æ–‡æœ¬æµ |
| ä¸Šä¼ æ–‡ä»¶  | `busboy`, `formidable`               | å¤§æ–‡ä»¶æµå¼ä¸Šä¼    |
| å‹ç¼©    | `zlib.createGzip()`                  | gzip å‹ç¼©æµ  |
| ä¸‹è½½    | `stream.pipeline`, `res.pipe()`      | å“åº”å¤§æ–‡ä»¶æµ    |
| è½¬æ¢    | `through2`, `stream.Transform`       | è‡ªå®šä¹‰æ•°æ®è½¬æ¢   |

---

## âœ… æ€»ç»“æœ€ä½³å®è·µ

| é¡¹ç›®     | å»ºè®®                                               |
| ------ | ------------------------------------------------ |
| æ–‡ä»¶è¯»å–   | å°½é‡ä½¿ç”¨ `fs.createReadStream()` æ›¿ä»£ `fs.readFile()`  |
| å†™å…¥     | ç”¨ `createWriteStream()` æ›¿ä»£ä¸€æ¬¡æ€§ `writeFile()`      |
| pipeé“¾è·¯ | `readable.pipe(transform).pipe(writable)` æ˜¯æœ€æ ‡å‡†å†™æ³• |
| é”™è¯¯å¤„ç†   | ä½¿ç”¨ `.on('error')` é¿å… silent fail                 |
| å›æ”¶èµ„æº   | è®°å¾—å…³é—­æµï¼Œæˆ–ç›‘å¬ `.on('close')`                         |

